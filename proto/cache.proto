// proto/cache.proto
syntax = "proto3";

option java_multiple_files = true;
package com.titancache.grpc;

service CacheService {
  rpc Put (CacheEntry) returns (EmptyResponse);
  rpc Get (KeyRequest) returns (ValueResponse);
  rpc Clear (EmptyRequest) returns (EmptyResponse);

  rpc SubmitTask (Task) returns (EmptyResponse);
  rpc LeaseTasks (LeaseRequest) returns (LeaseResponse);
  rpc SubmitBatch (BatchResult) returns (EmptyResponse);
}

service Health {
  rpc Check(HealthCheckRequest) returns (HealthCheckResponse);
  rpc Watch(HealthCheckRequest) returns (stream HealthCheckResponse);
}

message HealthCheckRequest {
  string service = 1;
}

message HealthCheckResponse {
  enum ServingStatus {
    UNKNOWN = 0;
    SERVING = 1;
    NOT_SERVING = 2;
  }
  ServingStatus status = 1;
}

message KeyRequest {
  string key = 1;
  string model_id = 2;
}

message ValueResponse {
  string value = 1;
  bool found = 2;
  string model_id = 3;
  string created_at = 4;
  float confidence_score = 5;
}

message CacheEntry {
  string key = 1;
  string value = 2;
  string model_id = 3;
  float confidence_score = 4; // Allow manual put
}

message LeaseRequest {
  int32 max_batch_size = 1;
  string target_model_id = 2;
}

message LeaseResponse {
  repeated Task tasks = 1;
}

message BatchResult {
  message Entry {
    string key = 1;
    string embedding_json = 2;
    float confidence_score = 3;
  }
  repeated Entry results = 1;
  string model_id = 2;
}

message EmptyRequest {}
message EmptyResponse { string message = 1; }

message Task {
  string hash = 1;
  string sequence = 2;
  string model_id = 3;
}